name: 'Run Squidler Test'
description: 'Runs the Squidler CLI test tool against a target URL.'
author: 'Squidler'

# Define Inputs for the Action
inputs:
  target-url:
    description: 'The starting URL for the Squidler test.'
    required: true
  site-id:
    description: 'The Squidler Site ID for associating results.'
    required: true
  api-key:
    description: 'Your Squidler API Key (should usually be a secret).'
    required: true
  no-tunnel:
    description: 'Disable local tunneling (recommended for public URLs).'
    required: false
    default: 'true'
  duration:
    description: 'Duration of the test in seconds.'
    required: false
    default: '10'
  username:
    description: 'Username for website login (optional).'
    required: false
  password:
    description: 'Password for website login (optional).'
    required: false
  cli-version:
    description: 'Specify a version of squidler-action-runner to use (e.g., latest, 0.1.2).'
    required: false
    default: '0.1.3'
  fail-on-problems:
    description: 'Make the action step fail if any problems are found by the CLI.'
    required: false
    default: 'false'
  fail-on-new-problems:
    description: 'Make the action step fail if any new problems are found by the CLI.'
    required: false
    default: 'false'

# Define Outputs for the Action
outputs:
  problem-count:
    description: "The total number of problems found in the report (set by CLI)."
  exit-code:
    description: "The raw exit code from the squidler-cli script."
    value: ${{ steps.run_cli.outputs.exit_code }}

runs:
  using: "composite"
  steps:
    - name: Construct CLI Command
      id: construct_cmd
      shell: bash
      run: |
        # Base command with required args using the action runner package
        CMD="npx @squidlerio/squidler-action-runner@${{ inputs.cli-version }} test ${{ inputs.target-url }}"
        CMD+=" --apikey '${{ inputs.api-key }}'"
        CMD+=" --siteid '${{ inputs.site-id }}'"

        # Add optional flags
        if [ "${{ inputs.no-tunnel }}" == "true" ]; then CMD+=" --no-tunnel=true"; fi
        if [ -n "${{ inputs.duration }}" ]; then CMD+=" --duration ${{ inputs.duration }}"; fi
        if [ -n "${{ inputs.username }}" ]; then CMD+=" --username '${{ inputs.username }}'"; fi
        if [ -n "${{ inputs.password }}" ]; then CMD+=" --password '${{ inputs.password }}'"; fi
        if [ "${{ inputs.fail-on-problems }}" == "true" ]; then CMD+=" --fail-on-problems"; fi
        if [ "${{ inputs.fail-on-new-problems }}" == "true" ]; then CMD+=" --fail-on-new-problems"; fi

        echo "Constructed command: ${CMD}"
        echo "cmd=$CMD" >> $GITHUB_OUTPUT

    - name: Run Squidler CLI
      id: run_cli
      shell: bash
      run: |
        # Run the command. CLI handles outputs/summary internally when in Actions.
        # CLI exits with non-zero code if --fail-on-problems=true and problems exist.
        ${{ steps.construct_cmd.outputs.cmd }}
        EXIT_CODE=$?
        # Output the raw exit code for the action's output
        echo "exit_code=${EXIT_CODE}" >> $GITHUB_OUTPUT
        # Exit the step with the script's exit code
        exit ${EXIT_CODE}

branding:
  icon: 'check-circle'
  color: 'blue'
